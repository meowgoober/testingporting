<!doctype html>
<html lang="en-us">
  <!-- Adapted for RenPyWeb from https://github.com/emscripten-core/emscripten/blob/master/src/shell.html -->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Class of '09</title>
    <script>
      var DEFAULT_GAME_FILENAME = 'game.zip';
    </script>
    <style>
      body {
        font-family: arial;
        margin: 0;
        padding: 0;
        background-color: black;
        overflow: hidden;
      }

      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      div.emscripten { text-align: center; }
      div.emscripten_border { border: 1px solid black; }
      /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
      canvas.emscripten { border: 0px none; background-color: black; width: 100vw; height: 100vh; display: block; }

      #emscripten_logo {
        display: inline-block;
        margin: 0;
      }

      .spinner {
        height: 30px;
        width: 30px;
        vertical-align: top;
        position: absolute;

        -webkit-animation: rotation .8s linear infinite;
        -moz-animation: rotation .8s linear infinite;
        -o-animation: rotation .8s linear infinite;
        animation: rotation 0.8s linear infinite;

        border-left: 5px solid rgb(235, 235, 235);
        border-right: 5px solid rgb(235, 235, 235);
        border-bottom: 5px solid rgb(235, 235, 235);
        border-top: 5px solid rgb(120, 120, 120);

        border-radius: 100%;
        background-color: rgb(189, 215, 46);
      }

      @-webkit-keyframes rotation {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
      }
      @-moz-keyframes rotation {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
      }
      @-o-keyframes rotation {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
      }
      @keyframes rotation {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
      }

      #statusbar_container {
        position: fixed;
        bottom: 20px; /* Moved to bottom to stay out of the way of the image */
        width: 100%;
        margin: auto;
        z-index: 100;
        display: none; /* Hidden by default for a clean look */
      }

      #statusbar {
        width: 50%;
        margin: auto;
        min-width: 340px;
        padding: 10px;
        height: 40px;
        background-color: rgba(40, 40, 40, 0.8);
        border-radius: 8px;
      }

      #status {
        vertical-align: top;
        font-weight: bold;
        color: rgb(200, 200, 200);
        width: 100%;
        padding-bottom: 2px;
        text-align: center;
      }

      #progress {
        height: 10px;
        width: 100%;
      }

      #ContextContainer {
        position: absolute;
        left: 10px;
        top: 10px;
        color: white;
        z-index: 101;
      }
      #ContextButton {
        text-decoration: none;
        color: rgba(128, 128, 128, 0.5);
        font-size: xx-large;
        cursor: pointer;
        user-select: none;
        -moz-user-select: none;
      }
      #ContextButton:focus {
        outline: none;
      }
      #ContextMenu a {
        text-decoration: none;
        color: lightgrey;
      }
      #ContextMenu a:hover {
        text-decoration: none;
        color: grey;
      }
      #ContextMenu {
        background-color: rgb(40,40,40);
        padding: 5px;
      }

      #presplash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: black;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #presplash img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
    </style>
  </head>
  <body>

    <!-- Presplash Container (Always on top initially) -->
    <div id="presplash">
        <img id="presplash_img" src="https://files.catbox.moe/88prnl.jpg" alt="Loading...">
    </div>

    <div id="statusbar_container">
      <div id="statusbar">
        <div class="spinner" id='spinner' style="display:none"></div>
        <div>
          <div class="emscripten" id="status"></div>
          <progress value="0" max="100" id="progress" hidden=1></progress>
        </div>
      </div>
    </div>

    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>

    <script>
      if (typeof WebAssembly !== 'object') {
          var error_message = "Unsupported browser - please upgrade!\n(WebAssembly support needed)";
          document.body.innerHTML = error_message.replace('\n', '<br />');
          throw error_message;
      }
      document.getElementById('canvas').addEventListener('mouseenter', function(e) { window.focus() });
      document.getElementById('canvas').addEventListener('click', function(e) { window.focus() });
    </script>

    <div id="ContextContainer">
      <a id="ContextButton">&#8801;</a><br />
      <div id="ContextMenu" style="display: none;">
        <input id="ID_SavegamesImport" type="file" onchange="onSavegamesImport(this)" accept="application/zip" style=display:none></input>
        <a href="javascript:document.getElementById('ID_SavegamesImport').click();">Import saves</a><br />
        <a href="javascript:onSavegamesExport();">Export saves</a><br />
        <a href="javascript:FSDownload('/log.txt', 'text/plain');">Ren'Py log</a><br />
      </div>
    </div>

    <script type='text/javascript'>
      document.getElementById('ContextButton').addEventListener('click', function (e) {
        var menu = document.getElementById('ContextMenu');
        menu.style.display = (menu.style.display == 'none') ? 'block' : 'none';
        e.preventDefault();
      });

      function onSavegamesImport(input) {
        reader = new FileReader();
        reader.onload = function(e) {
          FS.writeFile('savegames.zip', new Uint8Array(e.target.result));
          Module._emSavegamesImport();
          FS.syncfs(false, function(err) {
            if (err) console.error(err);
            else Module.print("Saves imported.\n");
          });
        }
        reader.readAsArrayBuffer(input.files[0])
      }

      function onSavegamesExport() {
        if (Module._emSavegamesExport()) FSDownload('savegames.zip', 'application/zip');
      }

      // Ren'Py 7.4.0 uses presplashEnd to signal the interface is ready
      function presplashEnd() {
        var presplash = document.getElementById('presplash');
        if (presplash) {
            presplash.style.transition = "opacity 0.5s ease";
            presplash.style.opacity = "0";
            setTimeout(function() {
                presplash.remove();
            }, 500);
        }
      }

      function gameExtractAndRun() {
        start = Date.now();
        var ret = Module.ccall('PyRun_SimpleString', 'number', ['string'], [
          "import zipfile\n" +
          "zip_ref = zipfile.ZipFile('game.zip', 'r')\n" +
          "zip_ref.extractall('.')\n" +
          "zip_ref.close()\n"
        ])
        if (ret != 0) {
            Module.setStatus("Error extracting .zip.");
            return;
        }
        FS.unlink('/game.zip')
        
        // Check for local presplash file if remote fails
        var img = document.getElementById('presplash_img');
        img.onerror = function() {
           let localFile;
           if (FS.readdir('/').indexOf('web-presplash.jpg') >= 0) localFile = FS.readFile('/web-presplash.jpg');
           else if (FS.readdir('/').indexOf('web-presplash.png') >= 0) localFile = FS.readFile('/web-presplash.png');
           if (localFile) img.src = window.URL.createObjectURL(new Blob([localFile]));
        };

        window.setTimeout(function() {
          Module.ccall('pyapp_runmain', '', [], [], {async: true})
        }, 100);
      }
      
      function FSDownload(filename, mimetype) {
        var a = document.createElement('a');
        a.download = filename.replace(/.*\//, '');
        try {
          a.href = window.URL.createObjectURL(new Blob([FS.readFile(filename)], { type: mimetype || '' }));
        } catch(e) { return; }
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    </script>
    <script type='text/javascript'>
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');
      var statusbarContainer = document.getElementById('statusbar_container');

      var Module = {
        preRun: [],
        postRun: [],
        print: function(text) { console.log(text); },
        printErr: function(text) { console.error(text); },
        canvas: document.getElementById('canvas'),
        setStatus: function(text) {
          if (!text) {
              statusbarContainer.style.display = 'none';
              return;
          }
          // Only show status bar if there's an actual message
          statusbarContainer.style.display = 'block';
          statusElement.innerHTML = text;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          if (m) {
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
          } else {
            progressElement.hidden = true;
          }
        },
        monitorRunDependencies: function(left) {
          Module.setStatus(left ? 'Preparing assets...' : '');
        }
      };

      (async function stitchAssets() {
        const baseUrl = "https://cdn.jsdelivr.net/gh/meowgoober/testingporting@main/classof09/gamezip/game.part";
        const totalParts = 4;
        const chunks = [];
        
        try {
          for (let i = 0; i < totalParts; i++) {
            Module.setStatus(`Downloading Part ${i + 1}/${totalParts}...`);
            const response = await fetch(`${baseUrl}${i}.zip`);
            if (!response.ok) throw new Error(`Part ${i} missing.`);
            chunks.push(await response.blob());
          }

          const fullBlob = new Blob(chunks, { type: "application/zip" });
          const arrayBuffer = await fullBlob.arrayBuffer();
          
          const checkFS = setInterval(() => {
            if (typeof FS !== 'undefined') {
              clearInterval(checkFS);
              FS.writeFile('game.zip', new Uint8Array(arrayBuffer));
              startEngine();
            }
          }, 100);
        } catch (e) {
          Module.setStatus("Download Error: " + e.message);
        }
      })();

      function startEngine() {
        const scripts = ["pythonhome-data.js", "pyapp-data.js", "zee.js", "index.js"];
        scripts.forEach(src => {
          const s = document.createElement('script');
          s.src = src;
          s.async = (src === "index.js");
          document.body.appendChild(s);
        });
      }
    </script>
    <script type='text/javascript'>
      function create_persistent() {
        try {
          FS.mkdir('/home/web_user/.renpy');
          FS.mount(IDBFS, {}, '/home/web_user/.renpy');
          FS.syncfs(true, function(err) {});
        } catch(e) {}
      }
      if (Module['calledRun']) create_persistent();
      else {
        if (!Module['preRun']) Module['preRun'] = [];
        Module["preRun"].push(create_persistent);
      }
    </script>
  </body>
</html>